**SCTP** (Stream Control Transmission Protocol) — протокол транспортного уровня, сочетающий черты TCP и UDP. SCTP обеспечивает надежную доставку с поддержкой мультиплексирования нескольких потоков, часто используется в телекоммуникациях, особенно для передачи сигнализации (SIGTRAN).

## **Основные характеристики**

| Параметр                    | Описание                                                                 |
| --------------------------- | ------------------------------------------------------------------------ |
| **Уровень OSI**             | Транспортный (Transport Layer)                                           |
| **Транспорт**               | IP (протокол 132)                                                         |
| **Тип протокола**           | С установлением соединения (connection-oriented)                        |
| **Надежность**              | Гарантирует доставку и порядок (как TCP)                                  |
| **Мультиплексирование**     | Несколько потоков в одном соединении                                     |
| **Multi-homing**            | Поддержка нескольких IP-адресов на конце                                 |
| **Сообщения**               | Сохраняет границы сообщений (как UDP)                                    |

## **Структура SCTP пакета**

### **SCTP Header (Общий заголовок)**

| Поле                    | Размер (байты) | Описание                                    |
| ----------------------- | -------------- | ------------------------------------------- |
| **Source Port**         | 2              | Порт отправителя                            |
| **Destination Port**    | 2              | Порт получателя                             |
| **Verification Tag**   | 4              | Тег для проверки ассоциации                |
| **Checksum**            | 4              | Контрольная сумма (CRC32c)                  |

### **SCTP Chunk (Блок данных)**

| Поле                    | Размер (байты) | Описание                                    |
| ----------------------- | -------------- | ------------------------------------------- |
| **Type**                | 1              | Тип блока                                   |
| **Flags**               | 1              | Флаги                                       |
| **Length**              | 2              | Длина блока (включая заголовок)             |
| **Data**                | Переменная     | Данные блока                                |

## **Типы SCTP блоков (Chunks)**

| Тип | Название        | Описание                                    |
| --- | --------------- | ------------------------------------------- |
| 0   | DATA            | Пользовательские данные                     |
| 1   | INIT            | Инициализация ассоциации                    |
| 2   | INIT-ACK        | Подтверждение инициализации                 |
| 3   | SACK            | Selective Acknowledgment                    |
| 4   | HEARTBEAT       | Проверка доступности                        |
| 5   | HEARTBEAT-ACK   | Подтверждение heartbeat                     |
| 6   | ABORT           | Прерывание ассоциации                       |
| 7   | SHUTDOWN        | Начало закрытия                             |
| 8   | SHUTDOWN-ACK    | Подтверждение закрытия                      |
| 9   | ERROR           | Сообщение об ошибке                         |
| 10  | COOKIE-ECHO     | Эхо cookie (защита от SYN flood)            |
| 11  | COOKIE-ACK      | Подтверждение cookie                        |
| 12  | ECNE            | Explicit Congestion Notification Echo      |
| 13  | CWR             | Congestion Window Reduce                    |
| 14  | SHUTDOWN-COMPLETE | Завершение закрытия                      |

## **Установление SCTP ассоциации (Four-Way Handshake)**

### **Процесс**

```
Клиент                          Сервер
  |                               |
  |-------- INIT ----------------→|
  |                               |
  |<-- INIT-ACK (Cookie) ---------|
  |                               |
  |-------- COOKIE-ECHO ---------→|
  |                               |
  |<-- COOKIE-ACK ----------------|
  |                               |
  |     Ассоциация установлена     |
```

**Этапы:**
1. **INIT** — клиент отправляет запрос с параметрами
2. **INIT-ACK** — сервер отвечает с cookie (защита от атак)
3. **COOKIE-ECHO** — клиент отправляет cookie обратно
4. **COOKIE-ACK** — сервер подтверждает, ассоциация установлена

**Защита от SYN Flood:**
- Cookie механизм защищает сервер от атак
- Сервер не хранит состояние до получения COOKIE-ECHO

## **Мультиплексирование потоков**

### **Потоки (Streams)**

SCTP поддерживает несколько независимых потоков в одной ассоциации:

```
Ассоциация
├── Stream 0 (надежный, упорядоченный)
├── Stream 1 (надежный, упорядоченный)
├── Stream 2 (надежный, упорядоченный)
└── Stream N
```

**Характеристики:**
- Каждый поток независим
- Порядок сохраняется внутри потока
- Потеря в одном потоке не блокирует другие (в отличие от TCP)

### **Head-of-Line Blocking**

В TCP потеря одного пакета блокирует все последующие. В SCTP:
- Потеря в Stream 0 не блокирует Stream 1
- Независимая обработка потоков

## **Multi-homing**

### **Концепция**

Один конец ассоциации может иметь несколько IP-адресов:

```
Клиент (Multi-homed)
├── IP: 192.168.1.10
├── IP: 192.168.1.11
└── IP: 10.0.0.10

Сервер (Multi-homed)
├── IP: 203.0.113.1
└── IP: 203.0.113.2
```

**Преимущества:**
- **Отказоустойчивость** — при отказе одного адреса используется другой
- **Балансировка нагрузки** — распределение по адресам
- **Мобильность** — смена адреса без разрыва соединения

### **Heartbeat механизм**

SCTP периодически отправляет HEARTBEAT для проверки доступности адресов:

```
Клиент → Сервер: HEARTBEAT (IP: 192.168.1.10)
Сервер → Клиент: HEARTBEAT-ACK (IP: 192.168.1.10)
```

Если адрес недоступен, используется альтернативный.

## **Надежность и управление потоком**

### **Selective Acknowledgment (SACK)**

SCTP использует SACK для выборочного подтверждения:

```
Отправитель отправил: [1000-2000] [2000-3000] [3000-4000] [4000-5000]
Получатель получил:   [1000-2000] [        ] [3000-4000] [4000-5000]
SACK указывает:       Получено: 1000-2000, 3000-5000
                      Пропущено: 2000-3000
Отправитель повторяет: [2000-3000]
```

**Преимущества:**
- Точное указание полученных блоков
- Эффективная повторная передача
- Меньше дублирования

### **Управление потоком**

Аналогично TCP:
- Sliding window
- Congestion control
- Flow control

## **Сообщения vs поток**

### **TCP (поток байтов)**

```
Отправитель: "Hello" "World"
Получатель:  "HelloWorld" (границы потеряны)
```

### **SCTP (сообщения)**

```
Отправитель: "Hello" "World"
Получатель:  "Hello" "World" (границы сохранены)
```

**Преимущество:**
- Сохранение границ сообщений
- Удобно для протоколов сигнализации

## **Применение SCTP**

### **1. SIGTRAN (Signaling Transport)**

Передача сигнализации SS7 через IP:

- **M3UA** (MTP3 User Adaptation) — поверх SCTP
- **SUA** (SCCP User Adaptation) — поверх SCTP
- **IUA** (ISDN User Adaptation) — поверх SCTP

**Преимущества:**
- Надежность SS7
- Гибкость IP сетей
- Multi-homing для отказоустойчивости

### **2. WebRTC**

Использование SCTP для передачи данных в WebRTC:

- Надежная передача данных
- Мультиплексирование потоков
- Поддержка в браузерах

### **3. VoIP**

Передача сигнализации в VoIP системах:

- Надежность
- Мультиплексирование
- Отказоустойчивость

### **4. Базы данных**

Кластерные базы данных:

- Репликация данных
- Мультиплексирование транзакций
- Отказоустойчивость

## **Примеры использования**

### **Linux - SCTP утилиты**

```bash
# Установка SCTP утилит
sudo apt-get install lksctp-tools

# Тестовая серверная программа
sctp_test -H 0.0.0.0 -P 5000 -l

# Тестовая клиентская программа
sctp_test -H 192.168.1.100 -P 5000 -s

# Просмотр SCTP соединений
netstat -an | grep sctp
ss -an | grep sctp
```

### **Python - pysctp**

```python
import sctp

# Создание SCTP сокета
sock = sctp.sctpsocket_tcp(socket.AF_INET)

# Подключение
sock.connect(('192.168.1.100', 5000))

# Отправка данных
sock.sctp_send('Hello', stream=0)

# Прием данных
data = sock.recv(1024)
```

### **Мониторинг SCTP**

```bash
# tcpdump - SCTP трафик
sudo tcpdump -i eth0 sctp

# Только INIT пакеты
sudo tcpdump -i eth0 'sctp[0] == 1'

# Wireshark фильтры
sctp
sctp.type == 1  # INIT
sctp.type == 0  # DATA
```

## **Сравнение с TCP и UDP**

| Характеристика | TCP | UDP | SCTP |
| -------------- | --- | --- | ---- |
| **Надежность** | Да  | Нет | Да   |
| **Порядок**    | Да  | Нет | Да (в потоке) |
| **Поток/Сообщения** | Поток | Сообщения | Сообщения |
| **Мультиплексирование** | Нет | Нет | Да |
| **Multi-homing** | Нет | Нет | Да |
| **Защита от SYN Flood** | Нет | Нет | Да (Cookie) |
| **Head-of-Line Blocking** | Да | Нет | Нет (между потоками) |

## **Безопасность SCTP**

### **Защита от атак**

1. **Cookie механизм** — защита от SYN Flood
2. **Verification Tag** — защита от подделки пакетов
3. **Checksum** — проверка целостности

### **Угрозы**

1. **Association Hijacking** — перехват ассоциации
2. **Flooding** — перегрузка сервера
3. **Man-in-the-Middle** — перехват трафика

## **Ограничения SCTP**

1. **Поддержка** — не все системы поддерживают SCTP
2. **NAT** — проблемы с NAT (как и TCP)
3. **Firewall** — может блокироваться firewall
4. **Сложность** — сложнее, чем TCP/UDP

## **Настройка SCTP**

### **Linux - параметры ядра**

```bash
# Просмотр параметров
sysctl net.sctp.*

# Максимальное количество ассоциаций
sysctl -w net.sctp.association_max=1024

# Таймаут heartbeat
sysctl -w net.sctp.heartbeat_interval=30000
```

### **Firewall правила**

```bash
# iptables - разрешить SCTP
iptables -A INPUT -p sctp -j ACCEPT
iptables -A OUTPUT -p sctp -j ACCEPT
```

## **Диагностика SCTP**

### **Проблемы и решения**

| Проблема                   | Причина                                  | Решение                                   |
| -------------------------- | ---------------------------------------- | ----------------------------------------- |
| **Не устанавливается ассоциация** | Firewall блокирует | Проверить firewall правила                |
| **Потеря пакетов**         | Проблемы сети                            | Проверить сеть, увеличить таймауты        |
| **Медленная передача**     | Перегрузка сети                          | Настроить congestion control              |

## **Будущее SCTP**

- **Улучшенная поддержка** — больше систем
- **WebRTC** — расширенное использование
- **5G** — использование в сетях 5G
- **Облачные сервисы** — использование в облаках

## **Альтернативы SCTP**

1. **TCP** — для простых случаев
2. **UDP** — для real-time без надежности
3. **QUIC** — современная альтернатива с мультиплексированием

## **Применение SCTP**

1. **Телекоммуникации** — SIGTRAN, передача сигнализации
2. **WebRTC** — передача данных в браузерах
3. **VoIP** — сигнализация в VoIP системах
4. **Кластерные системы** — репликация данных
5. **Финансовые системы** — надежная передача транзакций
