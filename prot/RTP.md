**RTP** (Real-time Transport Protocol) — протокол для фактической передачи аудио- и видеопотоков в реальном времени. RTP работает поверх UDP и обеспечивает доставку данных в реальном времени с временными метками и порядковыми номерами.

## **Основные характеристики**

| Параметр                    | Описание                                                                 |
| --------------------------- | ------------------------------------------------------------------------ |
| **Уровень OSI**             | Транспортный (Transport Layer)                                           |
| **Транспорт**               | UDP                                                                       |
| **Тип протокола**           | Без установления соединения                                              |
| **Назначение**              | Передача аудио и видео в реальном времени                                |
| **Сопутствующий протокол**  | RTCP (RTP Control Protocol)                                              |
| **Применение**              | VoIP, видеоконференции, потоковое вещание                                |

## **Структура RTP пакета**

### **RTP Header**

| Поле                    | Размер (биты) | Описание                                    |
| ----------------------- | -------------- | ------------------------------------------- |
| **V**                   | 2              | Версия (обычно 2)                            |
| **P**                   | 1              | Padding (заполнение)                         |
| **X**                   | 1              | Extension (расширение)                       |
| **CC**                  | 4              | CSRC Count (количество источников)          |
| **M**                   | 1              | Marker (маркер)                              |
| **PT**                  | 7              | Payload Type (тип полезной нагрузки)        |
| **Sequence Number**     | 16             | Номер последовательности                    |
| **Timestamp**           | 32             | Временная метка                             |
| **SSRC**                | 32             | Synchronization Source Identifier           |
| **CSRC**                | 32×N           | Contributing Source Identifiers (опционально) |
| **Payload**             | Переменная     | Медиа данные                                 |

**Размер заголовка:** 12 байт (базовый)

## **Payload Types**

### **Аудио кодеки**

| PT  | Кодек        | Частота дискретизации | Описание                                    |
| --- | ------------ | --------------------- | ------------------------------------------- |
| 0   | PCMU         | 8000 Hz               | G.711 μ-law                                 |
| 8   | PCMA         | 8000 Hz               | G.711 A-law                                 |
| 18  | G729         | 8000 Hz               | G.729                                       |
| 96  | Dynamic      | Переменная            | Динамический (определяется в SDP)           |

### **Видео кодеки**

| PT  | Кодек        | Описание                                    |
| --- | ------------ | ------------------------------------------- |
| 26  | JPEG         | JPEG видео                                  |
| 31  | H261         | H.261                                       |
| 32  | MPV          | MPEG-1 Video                                |
| 33  | MP2T         | MPEG-2 Transport                            |
| 96  | Dynamic      | Динамический (H.264, VP8 и т.д.)            |

## **RTCP (RTP Control Protocol)**

### **Назначение RTCP**

- **QoS мониторинг** — качество передачи
- **Синхронизация** — временная синхронизация
- **Идентификация** — информация об участниках
- **Контроль** — управление передачей

### **Типы RTCP пакетов**

| Тип | Название        | Описание                                    |
| --- | --------------- | ------------------------------------------- |
| 200 | SR              | Sender Report                               |
| 201 | RR              | Receiver Report                             |
| 202 | SDES            | Source Description                          |
| 203 | BYE             | Завершение участия                          |
| 204 | APP             | Application-specific                        |

## **Примеры использования**

### **Wireshark анализ**

```bash
# Фильтрация RTP трафика
rtp
rtp.payload_type == 0  # PCMU
rtp.ssrc == 0x12345678
```

### **Python (pyaudio + socket)**

```python
import socket
import struct

# Создание UDP сокета
sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)

# RTP заголовок
def create_rtp_header(seq_num, timestamp, ssrc, payload_type=0):
    version = 2
    padding = 0
    extension = 0
    cc = 0
    marker = 0
    pt = payload_type

    header = struct.pack('!BBHII',
        (version << 6) | (padding << 5) | (extension << 4) | cc,
        (marker << 7) | pt,
        seq_num,
        timestamp,
        ssrc
    )
    return header

# Отправка RTP пакета
seq_num = 0
timestamp = 0
ssrc = 0x12345678

while True:
    # Получение аудио данных
    audio_data = get_audio_data()

    # Создание RTP пакета
    rtp_header = create_rtp_header(seq_num, timestamp, ssrc)
    rtp_packet = rtp_header + audio_data

    # Отправка
    sock.sendto(rtp_packet, ('192.168.1.100', 5004))

    seq_num += 1
    timestamp += 160  # 20ms при 8kHz
```

## **SDP и RTP**

RTP параметры описываются в SDP:

```
v=0
o=alice 2890844526 2890844526 IN IP4 192.168.1.10
s=Session
c=IN IP4 192.168.1.10
t=0 0
m=audio 5004 RTP/AVP 0
a=rtpmap:0 PCMU/8000
a=rtcp:5005
```

**Параметры:**
- **m=** — медиа описание (тип, порт, протокол, payload type)
- **a=rtpmap:** — маппинг payload type на кодек
- **a=rtcp:** — порт RTCP

## **Применение RTP**

1. **VoIP** — передача голоса
2. **Видеоконференции** — передача видео
3. **Потоковое вещание** — live streaming
4. **IP телефония** — телефонные звонки через IP
5. **WebRTC** — медиа в браузерах

## **Ограничения RTP**

1. **Нет гарантии доставки** — работает поверх UDP
2. **Нет контроля перегрузки** — требует RTCP
3. **Проблемы с NAT** — требует STUN/TURN
4. **Jitter** — вариация задержки

## **Будущее RTP**

- **SRTP** — защищённый RTP (шифрование)
- **WebRTC** — интеграция с браузерами
- **5G** — использование в 5G сетях
- **Оптимизация** — улучшение производительности
