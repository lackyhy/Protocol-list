**UDP** (User Datagram Protocol) — быстрый протокол транспортного уровня без установления соединения (connectionless). UDP не гарантирует доставку, порядок пакетов и не имеет механизмов управления потоком. Используется для приложений, где скорость важнее надежности, таких как DNS, VoIP, онлайн-игры, потоковое видео.

## **Основные характеристики**

| Параметр                    | Описание                                                                 |
| --------------------------- | ------------------------------------------------------------------------ |
| **Уровень OSI**             | Транспортный (Transport Layer)                                           |
| **Тип протокола**           | Без установления соединения (connectionless)                             |
| **Надежность**              | Best-effort (не гарантирует доставку)                                    |
| **Порядок пакетов**         | Не гарантируется                                                         |
| **Дуплекс**                 | Полнодуплексный                                                          |
| **Заголовок**               | Минимальный (8 байт)                                                     |
| **Накладные расходы**       | Минимальные                                                               |

## **Структура UDP заголовка**

| Поле                    | Размер (байты) | Описание                                    | Пример/Значение                    |
| ----------------------- | -------------- | ------------------------------------------- | ---------------------------------- |
| **Source Port**         | 2              | Порт отправителя (опционально, может быть 0) | `0x0050` (80)                      |
| **Destination Port**    | 2              | Порт получателя                             | `0x0035` (53)                      |
| **Length**              | 2              | Длина UDP заголовка + данных (байты)        | `0x0020` (32 байта)                |
| **Checksum**            | 2              | Контрольная сумма заголовка и данных (опционально) | `0x1234` или `0x0000` (отключено) |

**Размер заголовка:** 8 байт (фиксированный)

**Инкапсуляция:**
```
IP Header | UDP Header | UDP Data
```

## **Особенности UDP**

### **1. Отсутствие установления соединения**

В отличие от TCP, UDP не требует handshake:
- Нет SYN/SYN-ACK/ACK
- Пакеты отправляются сразу
- Минимальная задержка

### **2. Отсутствие подтверждений**

- Нет ACK пакетов
- Отправитель не знает, доставлен ли пакет
- Приложения должны сами обрабатывать потери

### **3. Отсутствие управления потоком**

- Нет механизма sliding window
- Отправитель может отправлять с любой скоростью
- Риск перегрузки получателя

### **4. Отсутствие управления перегрузкой**

- Нет механизмов congestion control
- Может перегружать сеть
- Требуется контроль на уровне приложения

### **5. Минимальные накладные расходы**

- Заголовок всего 8 байт (vs 20+ байт в TCP)
- Нет опций
- Быстрая обработка

## **UDP Checksum**

### **Расчет контрольной суммы**

Контрольная сумма включает:
1. Псевдозаголовок (Source IP, Destination IP, Protocol, UDP Length)
2. UDP заголовок
3. UDP данные (дополненные до четного числа байт)

**Если Checksum = 0x0000:**
- Контрольная сумма отключена (RFC 768)
- Некоторые старые системы не проверяют checksum

**Проверка:**
- Получатель проверяет контрольную сумму
- При ошибке пакет отбрасывается (без уведомления)

## **Порты UDP**

### **Well-known порты (0-1023)**

| Порт | Протокол | Описание                                    |
| ---- | -------- | ------------------------------------------- |
| 53   | DNS      | Domain Name System                          |
| 67   | DHCP     | DHCP Server                                 |
| 68   | DHCP     | DHCP Client                                 |
| 69   | TFTP     | Trivial File Transfer Protocol              |
| 123  | NTP      | Network Time Protocol                        |
| 161  | SNMP     | Simple Network Management Protocol            |
| 162  | SNMP     | SNMP Trap                                   |
| 514  | Syslog   | System Logging Protocol                     |
| 520  | RIP      | Routing Information Protocol                |
| 1900 | SSDP     | Simple Service Discovery Protocol           |
| 5353 | mDNS     | Multicast DNS                               |

### **Registered порты (1024-49151)**

Зарегистрированные порты для приложений.

### **Dynamic/Private порты (49152-65535)**

Эфемерные порты для клиентских приложений.

## **Применение UDP**

### **1. DNS (Domain Name System)**

**Почему UDP:**
- Быстрые запросы-ответы
- Один пакет запрос, один пакет ответ
- Низкая задержка критична

**Особенности:**
- Запросы обычно < 512 байт
- При больших ответах используется TCP
- Порт 53

### **2. DHCP (Dynamic Host Configuration Protocol)**

**Почему UDP:**
- Broadcast запросы
- Не требуется надежность (повтор при необходимости)
- Низкая задержка при подключении

**Особенности:**
- Клиент: порт 68
- Сервер: порт 67
- Broadcast на этапе обнаружения

### **3. NTP (Network Time Protocol)**

**Почему UDP:**
- Периодические запросы
- Низкая задержка критична для синхронизации
- Простые запросы-ответы

**Особенности:**
- Порт 123
- Требуется точное время

### **4. VoIP (Voice over IP)**

**Почему UDP:**
- Real-time передача
- Потеря одного пакета менее критична, чем задержка
- Низкая задержка важнее надежности

**Особенности:**
- Используется RTP поверх UDP
- Кодеки компенсируют потери пакетов

### **5. Онлайн-игры**

**Почему UDP:**
- Real-time обновления
- Старые данные не нужны (не ждем retransmission)
- Низкая задержка критична

**Особенности:**
- Частые небольшие пакеты
- Клиентская интерполяция компенсирует потери

### **6. Потоковое видео**

**Почему UDP:**
- Real-time передача
- Потеря кадра менее критична, чем задержка
- Буферизация на клиенте

**Особенности:**
- Используется RTP/RTSP поверх UDP
- Адаптивное качество

### **7. SNMP (Simple Network Management Protocol)**

**Почему UDP:**
- Периодические запросы
- Простые запросы-ответы
- Низкие накладные расходы

**Особенности:**
- Порт 161 (запросы)
- Порт 162 (traps)

## **Примеры использования**

### **Отправка UDP пакета**

```bash
# Linux - netcat
echo "Hello" | nc -u 192.168.1.100 53

# С указанием порта источника
nc -u -p 12345 192.168.1.100 53

# Python пример
import socket
sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
sock.sendto(b"Hello", ("192.168.1.100", 53))
data, addr = sock.recvfrom(1024)
```

### **Просмотр UDP соединений**

```bash
# Linux
netstat -un
ss -un

# Вывод:
# UNCONN     0      0 192.168.1.10:123      0.0.0.0:*

# Windows
netstat -an | findstr UDP
```

### **Мониторинг UDP трафика**

```bash
# tcpdump
sudo tcpdump -i eth0 udp

# Только определенный порт
sudo tcpdump -i eth0 udp port 53

# Wireshark фильтры
udp
udp.port == 53
udp.length > 100
```

### **Тестирование UDP**

```bash
# iperf3 - UDP тест
iperf3 -c server.example.com -u -b 100M

# hping3 - отправка UDP пакетов
hping3 --udp -p 53 192.168.1.100

# nping - Nmap packet generation
nping --udp -p 53 192.168.1.100
```

## **Обработка ошибок в UDP**

### **На уровне приложения**

Поскольку UDP не гарантирует доставку, приложения должны:

1. **Повторные попытки**
   ```python
   import socket
   import time

   def send_with_retry(sock, data, addr, max_retries=3):
       for i in range(max_retries):
           sock.sendto(data, addr)
           sock.settimeout(1.0)
           try:
               response, _ = sock.recvfrom(1024)
               return response
           except socket.timeout:
               if i == max_retries - 1:
                   raise
           time.sleep(0.1)
   ```

2. **Проверка целостности**
   - Использовать контрольные суммы на уровне приложения
   - Проверять последовательность пакетов

3. **Таймауты**
   - Устанавливать таймауты на ответы
   - Повторять запросы при таймауте

4. **Обработка дубликатов**
   - Отслеживать уже обработанные пакеты
   - Игнорировать дубликаты

## **Ограничения UDP**

### **1. Нет гарантии доставки**

- Пакеты могут быть потеряны
- Нет уведомлений об ошибках
- Приложения должны обрабатывать потери

### **2. Нет гарантии порядка**

- Пакеты могут прибыть в другом порядке
- Приложения должны реорганизовывать

### **3. Нет управления потоком**

- Отправитель может перегрузить получателя
- Требуется контроль на уровне приложения

### **4. Нет управления перегрузкой**

- Может перегружать сеть
- Требуется контроль на уровне приложения

### **5. Ограничение размера пакета**

- Максимум 65,507 байт данных (65,535 - 8 UDP - 20 IP)
- На практике ограничено MTU сети (обычно 1500 байт)
- При превышении требуется фрагментация IP

## **UDP и NAT**

### **Проблемы с NAT**

UDP соединения через NAT могут иметь проблемы:

1. **Отображение портов**
   - NAT должен отслеживать UDP "соединения"
   - Таймаут обычно 30-120 секунд

2. **Hole Punching**
   - Техника для установления P2P соединений через NAT
   - Используется в VoIP и играх

3. **STUN/TURN**
   - Протоколы для обхода NAT
   - Используются в WebRTC

## **Безопасность UDP**

### **Угрозы**

1. **UDP Flood** — перегрузка сервера UDP пакетами
2. **Amplification Attacks** — использование серверов для усиления атак
   - DNS amplification
   - NTP amplification
   - SNMP amplification

### **Защита**

1. **Rate Limiting**
   ```bash
   # iptables - ограничение UDP пакетов
   iptables -A INPUT -p udp -m limit --limit 100/s -j ACCEPT
   ```

2. **Firewall**
   - Блокировка ненужных портов
   - Фильтрация по адресам

3. **Защита от amplification**
   - Отключение рекурсивных запросов для внешних
   - Ограничение ответов DNS

## **Сравнение с TCP**

| Характеристика | UDP | TCP |
| -------------- | --- | --- |
| **Соединение** | Нет | Да |
| **Надежность** | Нет | Да |
| **Порядок**    | Нет | Да |
| **Заголовок**  | 8 байт | 20+ байт |
| **Накладные расходы** | Минимальные | Высокие |
| **Задержка**   | Низкая | Высокая |
| **Применение** | DNS, VoIP, игры | HTTP, FTP, SSH |
| **Управление потоком** | Нет | Да |
| **Управление перегрузкой** | Нет | Да |

## **Оптимизация UDP**

### **1. Размер пакетов**

Оптимальный размер зависит от MTU:
- Ethernet: 1472 байта данных (1500 - 20 IP - 8 UDP)
- Избегать фрагментации IP

### **2. Буферизация**

```bash
# Linux - увеличение UDP буферов
sysctl -w net.core.rmem_max=16777216
sysctl -w net.core.wmem_max=16777216
```

### **3. Мультиплексирование**

Использование одного сокета для нескольких соединений:
- Эффективное использование ресурсов
- Меньше накладных расходов

## **Применение UDP**

1. **DNS запросы**
   - Быстрое разрешение имен
   - Низкая задержка

2. **DHCP**
   - Автоматическая конфигурация
   - Broadcast запросы

3. **VoIP**
   - Real-time голосовая связь
   - Низкая задержка важнее надежности

4. **Онлайн-игры**
   - Real-time обновления
   - Низкая задержка критична

5. **Потоковое видео**
   - Real-time передача
   - Адаптивное качество

6. **NTP**
   - Синхронизация времени
   - Точность важнее надежности

7. **SNMP**
   - Мониторинг сети
   - Периодические запросы

## **Когда использовать UDP**

**Используйте UDP когда:**
- Низкая задержка критична
- Потеря пакетов допустима
- Простые запросы-ответы
- Real-time приложения
- Broadcast/multicast нужен

**Не используйте UDP когда:**
- Требуется гарантированная доставка
- Важен порядок пакетов
- Нужно управление потоком
- Критична целостность данных
- Нет механизмов обработки ошибок

## **Будущее UDP**

### **QUIC (Quick UDP Internet Connections)**

Протокол от Google, работающий поверх UDP:
- Надежность поверх UDP
- Мультиплексирование потоков
- Встроенное шифрование
- Основа для HTTP/3

**Преимущества QUIC:**
- Быстрое установление соединения
- Меньше задержек
- Лучшая работа с мобильными сетями
