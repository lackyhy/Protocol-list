**ARP** (Address Resolution Protocol) — протокол канального уровня, используемый для преобразования IP-адресов (сетевого уровня) в MAC-адреса (физического уровня) в локальной сети. ARP является критически важным протоколом для работы Ethernet и других сетей, использующих MAC-адресацию.

## **Основные характеристики**

| Параметр                    | Описание                                                                 |
| --------------------------- | ------------------------------------------------------------------------ |
| **Уровень OSI**             | Канальный (Data Link Layer)                                              |
| **Тип протокола**           | Запрос-ответ (Request-Reply)                                             |
| **Инкапсуляция**            | Прямо в кадр Ethernet (Type: 0x0806)                                    |
| **Назначение**              | Разрешение адресов IP → MAC                                              |
| **Обратный протокол**       | RARP (Reverse ARP) — устаревший                                          |
| **Альтернативы**            | NDP (Neighbor Discovery Protocol) для IPv6                                |

## **Как работает ARP**

### **Базовый процесс**

```
1. Устройство A хочет отправить пакет устройству B (IP: 192.168.1.100)
2. Устройство A проверяет свою ARP таблицу
3. Если MAC-адрес не найден:
   a. Отправляет ARP Request (broadcast)
   b. Все устройства получают запрос
   c. Устройство B отвечает ARP Reply (unicast)
   d. Устройство A сохраняет MAC в ARP таблицу
4. Теперь устройство A может отправить кадр напрямую
```

## **Структура ARP пакета**

| Поле                    | Размер (байты) | Описание                                    | Пример/Значение                    |
| ----------------------- | -------------- | ------------------------------------------- | ---------------------------------- |
| **Hardware Type**       | 2              | Тип аппаратного адреса                      | `0x0001` (Ethernet)                |
| **Protocol Type**       | 2              | Тип протокольного адреса                    | `0x0800` (IPv4)                    |
| **Hardware Length**     | 1              | Длина аппаратного адреса (байты)            | `0x06` (6 байт для MAC)            |
| **Protocol Length**     | 1              | Длина протокольного адреса (байты)          | `0x04` (4 байта для IPv4)          |
| **Operation**            | 2              | Тип операции (Request/Reply)                | `0x0001` (Request), `0x0002` (Reply) |
| **Sender Hardware Address** | 6          | MAC-адрес отправителя                       | `00:1A:2B:3C:4D:5E`                |
| **Sender Protocol Address** | 4          | IP-адрес отправителя                        | `192.168.1.10`                      |
| **Target Hardware Address** | 6          | MAC-адрес получателя (00:00:00:00:00:00 для Request) | `00:00:00:00:00:00` или `AA:BB:CC:DD:EE:FF` |
| **Target Protocol Address** | 4          | IP-адрес получателя                         | `192.168.1.100`                     |

**Общий размер ARP пакета:** 28 байт

### **Инкапсуляция в Ethernet**

```
Ethernet Header:
  Destination MAC: FF:FF:FF:FF:FF:FF (broadcast для Request)
  Source MAC: MAC отправителя
  Type: 0x0806 (ARP)

ARP Packet (28 байт)
```

## **Типы ARP операций**

| Код (Hex) | Название              | Описание                                    |
| --------- | --------------------- | ------------------------------------------- |
| `0x0001`  | ARP Request           | Запрос MAC-адреса для IP-адреса             |
| `0x0002`  | ARP Reply             | Ответ с MAC-адресом                          |
| `0x0003`  | RARP Request          | Reverse ARP запрос (устаревший)             |
| `0x0004`  | RARP Reply            | Reverse ARP ответ (устаревший)              |
| `0x0005`  | InARP Request         | Inverse ARP запрос                           |
| `0x0006`  | InARP Reply           | Inverse ARP ответ                            |
| `0x0008`  | ARP NAK               | Отрицательный ответ (редко используется)    |

## **Hardware Type значения**

| Значение | Тип оборудования                        |
| -------- | --------------------------------------- |
| `0x0001` | Ethernet (10 Мбит/с)                    |
| `0x0006` | IEEE 802 Networks                       |
| `0x0007` | ARCNET                                  |
| `0x000F` | Frame Relay                             |
| `0x0010` | Asynchronous Transfer Mode (ATM)        |
| `0x0014` | SMDS                                    |
| `0x0015` | X.25                                    |
| `0x0016` | HDLC                                    |
| `0x0017` | Fibre Channel                           |
| `0x0018` | ATM                                     |
| `0x0019` | Serial Line                               |
| `0x001A` | ATM                                     |
| `0x001B` | MIL-STD-188-220                         |
| `0x001C` | Metricom                                |
| `0x001D` | IEEE 1394.1995                          |
| `0x001E` | MAPOS                                   |
| `0x001F` | Twinaxial                               |
| `0x0020` | EUI-64                                  |
| `0x0021` | HIPARP                                  |
| `0x0022` | IP and ARP over ISO 7816-3              |
| `0x0023` | ARPSec                                  |
| `0x0024` | IPsec tunnel                            |
| `0x0025` | InfiniBand                              |

## **ARP таблица (ARP Cache)**

Каждое устройство поддерживает таблицу соответствия IP → MAC адресов.

### **Структура записи**

| Поле              | Описание                                    |
| ----------------- | ------------------------------------------- |
| **IP Address**    | IP-адрес устройства                         |
| **MAC Address**    | Соответствующий MAC-адрес                   |
| **Type**          | Тип записи (static/dynamic)                 |
| **Interface**     | Сетевой интерфейс                           |
| **Age**           | Время жизни записи (TTL)                    |

### **Типы записей**

1. **Dynamic (динамические)**
   - Автоматически добавляются при ARP запросах
   - Имеют ограниченное время жизни (обычно 2-4 минуты)
   - Автоматически удаляются при истечении TTL

2. **Static (статические)**
   - Добавляются вручную администратором
   - Не имеют времени жизни
   - Сохраняются до перезагрузки или ручного удаления

## **Примеры использования**

### **Linux - просмотр ARP таблицы**

```bash
# Просмотр ARP таблицы
arp -a
# или
ip neigh show

# Вывод:
# ? (192.168.1.1) at 00:1a:2b:3c:4d:5e [ether] on eth0
# ? (192.168.1.100) at aa:bb:cc:dd:ee:ff [ether] on eth0

# Детальная информация
ip -s neigh show

# Добавление статической записи
sudo arp -s 192.168.1.100 aa:bb:cc:dd:ee:ff
# или
sudo ip neigh add 192.168.1.100 lladdr aa:bb:cc:dd:ee:ff dev eth0

# Удаление записи
sudo arp -d 192.168.1.100
# или
sudo ip neigh del 192.168.1.100 dev eth0

# Очистка всей таблицы
sudo ip -s neigh flush all
```

### **Windows - просмотр ARP таблицы**

```powershell
# Просмотр ARP таблицы
arp -a

# Вывод:
# Interface: 192.168.1.10 --- 0x2
#   Internet Address      Physical Address      Type
#   192.168.1.1           00-1a-2b-3c-4d-5e     dynamic
#   192.168.1.100         aa-bb-cc-dd-ee-ff     dynamic

# Добавление статической записи
arp -s 192.168.1.100 aa-bb-cc-dd-ee-ff

# Удаление записи
arp -d 192.168.1.100
```

### **Мониторинг ARP трафика**

```bash
# Linux - tcpdump
sudo tcpdump -i eth0 arp

# Вывод ARP запроса:
# 15:30:45.123456 ARP, Request who-has 192.168.1.100 tell 192.168.1.10, length 28
# 15:30:45.123789 ARP, Reply 192.168.1.100 is-at aa:bb:cc:dd:ee:ff, length 28

# Wireshark фильтр
arp

# Только ARP запросы
arp.opcode == 1

# Только ARP ответы
arp.opcode == 2
```

## **Варианты ARP**

### **1. Proxy ARP**

Маршрутизатор отвечает на ARP запросы от имени других устройств.

**Применение:**
- Устройства в разных подсетях
- Упрощение конфигурации сети
- Мобильные устройства

**Пример:**
```
Устройство A (192.168.1.10) хочет связаться с устройством B (192.168.2.20)
Маршрутизатор отвечает ARP Reply со своим MAC-адресом
Трафик идет через маршрутизатор
```

### **2. Gratuitous ARP (GARP)**

ARP пакет, где отправитель и получатель — одно и то же устройство.

**Применение:**
- Обновление ARP таблиц других устройств
- Обнаружение конфликтов IP-адресов
- Уведомление о смене MAC-адреса

**Формат:**
```
Sender IP = Target IP = IP устройства
Target MAC = 00:00:00:00:00:00 (для запроса)
```

### **3. Reverse ARP (RARP) - УСТАРЕВШИЙ**

Преобразование MAC → IP (обратное ARP).

**Применение:**
- Использовался для загрузки бездисковых рабочих станций
- Заменен на BOOTP и DHCP

### **4. Inverse ARP (InARP)**

Используется в Frame Relay и ATM для определения IP по DLCI/VPI-VCI.

### **5. ARP Announcement**

Разновидность Gratuitous ARP, используемая для объявления IP-адреса.

## **ARP атаки и защита**

### **1. ARP Spoofing (ARP Poisoning)**

Атака, при которой злоумышленник отправляет поддельные ARP ответы.

**Механизм:**
```
1. Злоумышленник отправляет ARP Reply:
   IP: 192.168.1.1 (шлюз)
   MAC: MAC-адрес злоумышленника
2. Жертва обновляет ARP таблицу
3. Трафик к шлюзу идет через злоумышленника
4. Возможен MITM (Man-in-the-Middle) атака
```

**Защита:**
- Статические ARP записи для критичных устройств
- ARP мониторинг (arpwatch, arpalert)
- Использование защищенных протоколов (HTTPS, SSH)
- Port Security на коммутаторах

### **2. ARP Flooding**

Отправка большого количества ARP запросов для перегрузки коммутатора.

**Защита:**
- Ограничение скорости ARP запросов
- Port Security
- DHCP Snooping

### **3. ARP Cache Poisoning**

Заполнение ARP таблицы поддельными записями.

**Защита:**
- Регулярная очистка ARP таблицы
- Мониторинг изменений
- Использование статических записей

## **ARP в разных сетях**

### **Ethernet**

Стандартное использование ARP в Ethernet сетях.

### **Wi-Fi**

ARP работает аналогично, но через беспроводной интерфейс.

### **VLAN**

ARP работает внутри каждого VLAN отдельно.

### **IPv6**

ARP заменен на **NDP (Neighbor Discovery Protocol)**, который использует ICMPv6.

## **Диагностика ARP проблем**

### **Типичные проблемы**

| Проблема                   | Причина                                  | Решение                                   |
| -------------------------- | ---------------------------------------- | ----------------------------------------- |
| **Нет связи с устройством** | Неверный MAC в ARP таблице               | Очистить ARP таблицу, повторить запрос    |
| **Дублирование IP**        | Два устройства с одним IP                | Проверить конфликт, изменить IP           |
| **Медленная связь**        | ARP Spoofing, неправильный маршрут       | Проверить ARP таблицу, использовать статические записи |
| **Периодические обрывы**   | Проблемы с ARP кешем                    | Увеличить TTL, проверить сетевые настройки |

### **Инструменты диагностики**

```bash
# Проверка ARP таблицы
arp -a
ip neigh show

# Отправка ARP запроса вручную
arping -c 3 192.168.1.100

# Мониторинг ARP трафика
tcpdump -i eth0 arp

# Проверка конфликтов IP
arping -D -I eth0 192.168.1.100
# Если ответ получен - конфликт обнаружен
```

## **ARP и производительность**

### **Оптимизация**

1. **Увеличение TTL для стабильных устройств**
   ```bash
   # Linux - изменение базового TTL
   sysctl net.ipv4.neigh.default.base_reachable_time_ms
   ```

2. **Использование статических записей для критичных устройств**
   - Шлюзы
   - Серверы
   - Принтеры

3. **ARP кеширование**
   - Операционные системы автоматически кешируют ARP записи
   - TTL обычно 2-4 минуты

## **Сравнение с NDP (IPv6)**

| Характеристика | ARP (IPv4) | NDP (IPv6) |
| -------------- | ---------- | ---------- |
| **Протокол**   | Отдельный протокол | Часть ICMPv6 |
| **Тип кадра**  | Ethernet Type 0x0806 | ICMPv6 |
| **Multicast**  | Broadcast запросы | Multicast запросы |
| **Безопасность** | Нет встроенной | SEND (Secure Neighbor Discovery) |
| **Автоконфигурация** | Нет | Да (SLAAC) |

## **Применение ARP**

1. **Локальные сети**
   - Определение MAC-адресов в той же подсети
   - Необходим для отправки Ethernet кадров

2. **Маршрутизация**
   - Определение MAC-адреса шлюза
   - Первый шаг перед отправкой пакета

3. **Сетевой мониторинг**
   - Отслеживание устройств в сети
   - Обнаружение новых устройств

4. **Безопасность**
   - Обнаружение ARP атак
   - Мониторинг сетевой активности
