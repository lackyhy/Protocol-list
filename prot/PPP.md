**PPP** (Point-to-Point Protocol) — протокол канального уровня, используемый для установления прямого соединения между двумя узлами. PPP широко применяется в dial-up подключениях, DSL, и других последовательных соединениях. Протокол обеспечивает аутентификацию, сжатие данных и мультиплексирование различных сетевых протоколов.

## **Основные характеристики**

| Параметр                    | Описание                                                                 |
| --------------------------- | ------------------------------------------------------------------------ |
| **Уровень OSI**             | Канальный (Data Link Layer)                                              |
| **Тип соединения**          | Точка-точка (Point-to-Point)                                             |
| **Аутентификация**          | PAP, CHAP, EAP                                                            |
| **Сжатие**                  | Van Jacobson, Predictor, MPPC                                           |
| **Мультиплексирование**     | Поддержка нескольких протоколов (IP, IPX, AppleTalk)                    |
| **Обнаружение ошибок**      | CRC (Cyclic Redundancy Check)                                            |
| **Максимальный размер кадра** | 1500 байт (по умолчанию)                                                |

## **Компоненты PPP**

### **1. LCP (Link Control Protocol)**

Управляет установлением, настройкой, тестированием и завершением соединения.

**Основные функции:**
- Согласование параметров соединения
- Обнаружение конфигурационных ошибок
- Определение качества соединения
- Завершение соединения

### **2. NCP (Network Control Protocol)**

Управляет настройкой различных сетевых протоколов поверх PPP.

**Типы NCP:**
- **IPCP** (IP Control Protocol) — для IP
- **IPXCP** (IPX Control Protocol) — для IPX
- **ATCP** (AppleTalk Control Protocol) — для AppleTalk

### **3. Протоколы аутентификации**

- **PAP** (Password Authentication Protocol)
- **CHAP** (Challenge Handshake Authentication Protocol)
- **EAP** (Extensible Authentication Protocol)

## **Структура кадра PPP**

| Поле                    | Размер (байты) | Описание                                    | Пример/Значение                    |
| ----------------------- | -------------- | ------------------------------------------- | ---------------------------------- |
| **Flag**                | 1              | Начало/конец кадра (0x7E)                   | `0x7E`                             |
| **Address**              | 1              | Адрес получателя (0xFF — broadcast)         | `0xFF`                             |
| **Control**              | 1              | Управляющая информация (0x03 — unnumbered) | `0x03`                             |
| **Protocol**             | 2              | Тип инкапсулированного протокола            | `0x0021` (IP), `0xC021` (LCP)      |
| **Data/Payload**         | 0-1500         | Полезная нагрузка                            | IP пакет, LCP пакет и т.д.         |
| **FCS**                  | 2 или 4        | Контрольная сумма (CRC)                     | Рассчитывается на лету             |
| **Flag**                 | 1              | Конец кадра (0x7E)                          | `0x7E`                             |

### **Протокольные поля**

| Значение (Hex) | Протокол | Описание                                    |
| -------------- | -------- | ------------------------------------------- |
| `0x0021`       | IP       | Internet Protocol                            |
| `0x0029`       | AT       | AppleTalk                                    |
| `0x002B`       | IPX      | Internetwork Packet Exchange                 |
| `0xC021`       | LCP      | Link Control Protocol                        |
| `0xC023`       | PAP      | Password Authentication Protocol             |
| `0xC223`       | CHAP     | Challenge Handshake Authentication Protocol  |
| `0x8021`       | IPCP     | IP Control Protocol                          |
| `0x8029`       | ATCP     | AppleTalk Control Protocol                   |
| `0x802B`       | IPXCP    | IPX Control Protocol                         |

## **Процесс установления PPP соединения**

### **Этап 1: Установление связи (Link Establishment)**

```
1. LCP Configure-Request отправляется обеими сторонами
2. LCP Configure-Ack подтверждает параметры
3. Соединение установлено на канальном уровне
```

**LCP опции:**
- **Maximum Receive Unit (MRU)** — максимальный размер кадра
- **Authentication Protocol** — выбор протокола аутентификации
- **Quality Protocol** — протокол контроля качества
- **Magic Number** — для обнаружения петель
- **Protocol Field Compression** — сжатие поля протокола
- **Address and Control Field Compression** — сжатие полей адреса и управления

### **Этап 2: Аутентификация (Authentication)**

#### **PAP (Password Authentication Protocol)**

```
1. Клиент → Сервер: Username + Password (в открытом виде)
2. Сервер → Клиент: Accept или Reject
```

**Характеристики PAP:**
- Простой протокол
- Пароль передается в открытом виде
- Уязвим к перехвату
- Используется редко

#### **CHAP (Challenge Handshake Authentication Protocol)**

```
1. Сервер → Клиент: Challenge (случайное число)
2. Клиент → Сервер: Response (MD5 hash от Challenge + пароль + ID)
3. Сервер → Клиент: Success или Failure
```

**Характеристики CHAP:**
- Пароль никогда не передается по сети
- Использует хеширование (MD5, SHA-1)
- Периодическая повторная аутентификация
- Более безопасен, чем PAP

**Формат CHAP пакета:**

| Поле        | Размер | Описание                                    |
| ----------- | ------ | ------------------------------------------- |
| **Code**    | 1      | Тип сообщения (1=Challenge, 2=Response, 3=Success, 4=Failure) |
| **Identifier** | 1   | Идентификатор для сопоставления запрос-ответ |
| **Length**  | 2      | Длина пакета                                |
| **Value**   | Переменная | Challenge или Response (хеш)            |
| **Name**    | Переменная | Имя пользователя (опционально)          |

### **Этап 3: Настройка сети (Network Layer Protocol)**

```
1. NCP Configure-Request (например, IPCP)
2. NCP Configure-Ack
3. Сетевое соединение готово
```

**IPCP опции:**
- **IP Address** — назначение IP-адреса
- **IP Compression Protocol** — сжатие IP заголовков
- **Primary DNS Server** — адрес DNS сервера
- **Secondary DNS Server** — резервный DNS сервер

### **Этап 4: Передача данных (Data Transfer)**

После успешной настройки начинается передача данных.

### **Этап 5: Завершение соединения (Link Termination)**

```
1. LCP Terminate-Request
2. LCP Terminate-Ack
3. Соединение закрыто
```

## **LCP (Link Control Protocol) пакеты**

| Код | Название              | Описание                                    |
| --- | --------------------- | ------------------------------------------- |
| 1   | Configure-Request     | Запрос настройки параметров                 |
| 2   | Configure-Ack         | Подтверждение конфигурации                  |
| 3   | Configure-Nak         | Отклонение с предложением альтернативы      |
| 4   | Configure-Reject      | Отклонение нераспознаваемой опции           |
| 5   | Terminate-Request     | Запрос на завершение соединения             |
| 6   | Terminate-Ack         | Подтверждение завершения                    |
| 7   | Code-Reject           | Отклонение неизвестного кода                |
| 8   | Protocol-Reject       | Отклонение неизвестного протокола           |
| 9   | Echo-Request          | Запрос эха (для проверки соединения)        |
| 10  | Echo-Reply            | Ответ на эхо                                |
| 11  | Discard-Request       | Запрос на отбрасывание (для тестирования)   |

## **PPP варианты**

### **1. PPPoE (PPP over Ethernet)**

Используется в DSL подключениях.

**Характеристики:**
- PPP инкапсулируется в Ethernet кадры
- Использует MAC-адреса вместо последовательных интерфейсов
- Широко применяется в ADSL/VDSL

**Структура PPPoE:**
```
Ethernet Header | PPPoE Header | PPP Header | Data | FCS
```

**PPPoE этапы:**
1. **Discovery** — обнаружение сервера (PADI, PADO, PADR, PADS)
2. **Session** — установление PPP сессии
3. **Termination** — завершение сессии (PADT)

### **2. PPPoA (PPP over ATM)**

Используется в некоторых DSL подключениях.

**Характеристики:**
- PPP инкапсулируется в ATM ячейки
- Прямая инкапсуляция без Ethernet
- Меньше накладных расходов, чем PPPoE

### **3. PPTP (Point-to-Point Tunneling Protocol)**

VPN протокол на основе PPP.

**Характеристики:**
- Инкапсулирует PPP в IP пакеты
- Использует TCP для управления (порт 1723)
- GRE для передачи данных
- Считается небезопасным

## **Сжатие данных**

### **Van Jacobson Compression (VJ Compression)**

Сжимает IP и TCP заголовки.

**Принцип:**
- Отслеживает изменения в заголовках
- Передает только разницу
- Эффективно для telnet и других интерактивных протоколов

### **Predictor Compression**

Алгоритм сжатия на основе предсказания.

### **MPPC (Microsoft Point-to-Point Compression)**

Проприетарный алгоритм сжатия от Microsoft.

## **Примеры конфигурации**

### **Linux (pppd)**

```bash
# Конфигурационный файл /etc/ppp/options
lock
modem
crtscts
asyncmap 0
noauth
defaultroute
usepeerdns

# Конфигурация для CHAP
# /etc/ppp/chap-secrets
# client    server    secret    IP addresses
user1      *         password1  *

# Запуск pppd
sudo pppd /dev/ttyS0 115200 \
    connect 'chat -v "" AT OK ATDT1234567 CONNECT ""' \
    user user1 password password1 \
    noauth defaultroute usepeerdns
```

### **PPPoE клиент (Linux)**

```bash
# Установка pppoe
sudo apt-get install pppoeconf

# Конфигурация
sudo pppoeconf

# Запуск
sudo pon dsl-provider

# Остановка
sudo poff

# Статус
plog
```

### **Windows (RAS)**

```powershell
# Создание PPP соединения через GUI:
# Control Panel > Network and Sharing Center >
# Set up a new connection or network >
# Connect to the Internet > Dial-up
```

## **Диагностика PPP**

### **Логирование**

```bash
# Linux pppd логи
tail -f /var/log/messages
plog

# Включение отладки
sudo pppd debug /dev/ttyS0
```

### **Мониторинг соединения**

```bash
# Статус интерфейса
ip link show ppp0
ifconfig ppp0

# Статистика
cat /proc/net/dev
```

### **Типичные проблемы**

| Проблема                   | Причина                                  | Решение                                   |
| -------------------------- | ---------------------------------------- | ----------------------------------------- |
| **Не устанавливается связь** | Неверные параметры LCP                  | Проверить конфигурацию                    |
| **Ошибка аутентификации** | Неверный пароль, неподдерживаемый протокол | Проверить credentials, использовать CHAP |
| **Нет IP адреса**         | Проблемы с IPCP                          | Проверить настройки IPCP                  |
| **Обрывы соединения**     | Плохая линия, таймауты                   | Проверить качество линии                 |

## **Безопасность PPP**

### **Рекомендации**

1. **Использовать CHAP вместо PAP**
   - CHAP не передает пароль в открытом виде
   - Поддерживает периодическую переаутентификацию

2. **Использовать EAP для расширенной аутентификации**
   - Поддержка различных методов (сертификаты, токены)
   - Используется в PPPoE и других вариантах

3. **Шифрование данных**
   - Использовать IPsec поверх PPP
   - Или использовать VPN (L2TP/IPsec)

4. **Ограничение попыток аутентификации**
   - Защита от brute-force атак
   - Блокировка после нескольких неудачных попыток

## **Сравнение с другими протоколами**

| Протокол | Уровень | Использование | Аутентификация |
| -------- | ------- | ------------- | -------------- |
| **PPP**  | Канальный | Dial-up, DSL | PAP, CHAP, EAP |
| **SLIP** | Канальный | Устаревший | Нет            |
| **HDLC** | Канальный | WAN соединения | Нет            |
| **Frame Relay** | Канальный | WAN | Нет (на уровне протокола) |

## **Применение PPP**

1. **Dial-up подключения**
   - Модемные соединения через телефонную линию
   - Устаревающая технология

2. **DSL подключения**
   - PPPoE в ADSL/VDSL
   - Широко используется провайдерами

3. **Сотовые сети**
   - 3G/4G модемы
   - Инкапсуляция PPP в сотовые протоколы

4. **VPN туннели**
   - PPTP (устаревший)
   - L2TP/IPsec использует PPP

5. **Последовательные соединения**
   - Прямые кабельные соединения
   - Использование в промышленных системах
