**TCP** (Transmission Control Protocol) — надежный протокол транспортного уровня с установлением соединения. TCP гарантирует доставку данных, порядок пакетов, обнаружение ошибок и управление потоком. Является основой для многих прикладных протоколов, включая HTTP, HTTPS, SSH, FTP.

## **Основные характеристики**

| Параметр                    | Описание                                                                 |
| --------------------------- | ------------------------------------------------------------------------ |
| **Уровень OSI**             | Транспортный (Transport Layer)                                           |
| **Тип протокола**           | С установлением соединения (connection-oriented)                         |
| **Надежность**              | Гарантирует доставку, порядок, целостность                              |
| **Дуплекс**                 | Полнодуплексный (одновременная передача в обе стороны)                  |
| **Поток данных**            | Байтовый поток (не сообщения)                                            |
| **Управление потоком**      | Sliding window (скользящее окно)                                         |
| **Управление перегрузкой**  | Congestion control (контроль перегрузки)                                |

## **Структура TCP сегмента**

| Поле                    | Размер (байты) | Описание                                    | Пример/Значение                    |
| ----------------------- | -------------- | ------------------------------------------- | ---------------------------------- |
| **Source Port**         | 2              | Порт отправителя                            | `0x0050` (80)                      |
| **Destination Port**    | 2              | Порт получателя                             | `0x01BB` (443)                     |
| **Sequence Number**     | 4              | Номер последовательности байтов             | `0x12345678`                       |
| **Acknowledgment Number** | 4            | Номер следующего ожидаемого байта           | `0x12345679`                       |
| **Data Offset**         | 4 бита         | Длина заголовка в 32-битных словах          | `0101` (5 = 20 байт)               |
| **Reserved**            | 3 бита         | Зарезервировано (должно быть 0)             | `000`                             |
| **Flags**               | 9 бит          | Управляющие флаги                           | См. таблицу флагов                 |
| **Window Size**         | 2              | Размер окна приема (в байтах)               | `0x2000` (8192 байт)               |
| **Checksum**            | 2              | Контрольная сумма заголовка и данных        | Рассчитывается на лету             |
| **Urgent Pointer**      | 2              | Указатель на срочные данные (если URG=1)    | `0x0000`                           |
| **Options**             | Переменная     | Опции (опционально)                         | MSS, Window Scale, SACK и т.д.    |
| **Data**                | Переменная     | Полезная нагрузка                            | Данные приложения                  |

**Минимальный размер заголовка:** 20 байт (без опций)
**Максимальный размер заголовка:** 60 байт (с опциями)

### **TCP флаги (Flags)**

| Бит | Название | Описание                                    |
| --- | -------- | ------------------------------------------- |
| 0   | **URG**  | Urgent - срочные данные                     |
| 1   | **ACK**  | Acknowledgment - подтверждение              |
| 2   | **PSH**  | Push - немедленная передача данных          |
| 3   | **RST**  | Reset - сброс соединения                    |
| 4   | **SYN**  | Synchronize - установление соединения      |
| 5   | **FIN**  | Finish - завершение соединения              |
| 6-8 | Reserved | Зарезервировано                            |

## **Установление TCP соединения (Three-Way Handshake)**

```
Клиент                          Сервер
  |                               |
  |-------- SYN (seq=x) -------->|
  |                               |
  |<-- SYN-ACK (seq=y, ack=x+1) --|
  |                               |
  |-------- ACK (ack=y+1) ------->|
  |                               |
  |     Соединение установлено    |
```

**Этапы:**
1. **SYN** — клиент отправляет запрос с начальным номером последовательности (ISN)
2. **SYN-ACK** — сервер отвечает SYN-ACK с своим ISN и подтверждением получения SYN
3. **ACK** — клиент подтверждает получение SYN-ACK

**Номера последовательности:**
- Начальный номер (ISN) выбирается случайно
- Каждый байт данных увеличивает номер последовательности
- ACK подтверждает получение всех байтов до указанного номера

## **Завершение TCP соединения (Four-Way Handshake)**

```
Клиент                          Сервер
  |                               |
  |-------- FIN (seq=x) -------->|
  |                               |
  |<-- ACK (ack=x+1) -------------|
  |                               |
  |<-- FIN (seq=y) ---------------|
  |                               |
  |-------- ACK (ack=y+1) ------->|
  |                               |
  |     Соединение закрыто        |
```

**Этапы:**
1. **FIN** — одна сторона отправляет запрос на закрытие
2. **ACK** — другая сторона подтверждает получение FIN
3. **FIN** — вторая сторона отправляет свой FIN
4. **ACK** — первая сторона подтверждает получение FIN

**Примечание:** FIN и ACK могут быть объединены в один пакет (FIN-ACK).

## **Управление потоком (Flow Control)**

### **Sliding Window (Скользящее окно)**

Механизм управления количеством неподтвержденных данных.

**Принцип:**
- Получатель указывает размер окна (Window Size)
- Отправитель может отправить только Window Size байт без подтверждения
- При получении данных окно "скользит" вперед

**Пример:**
```
Отправитель может отправить: [seq=1000, window=5000]
Может отправить байты: 1000-5999
После отправки 2000 байт: [seq=3000, window=3000]
```

### **Zero Window**

Если получатель не может принимать данные, он отправляет Window Size = 0.

**Процесс:**
1. Получатель отправляет Window = 0
2. Отправитель останавливает передачу
3. Получатель периодически отправляет Window Probe
4. Когда готов, получатель отправляет Window > 0

## **Управление перегрузкой (Congestion Control)**

### **Алгоритмы**

| Алгоритм           | Описание                                    |
| ------------------ | ------------------------------------------- |
| **Slow Start**     | Экспоненциальное увеличение окна           |
| **Congestion Avoidance** | Линейное увеличение окна            |
| **Fast Retransmit** | Быстрая повторная передача при дублировании ACK |
| **Fast Recovery**  | Восстановление после быстрой повторной передачи |

### **Состояния окна перегрузки**

1. **Slow Start**
   - Начальное окно: 1-4 сегмента (обычно 2)
   - Удваивается при каждом ACK
   - Продолжается до достижения ssthresh

2. **Congestion Avoidance**
   - Линейное увеличение: +1 сегмент на RTT
   - Активируется после достижения ssthresh

3. **При обнаружении потери**
   - ssthresh = текущее окно / 2
   - Окно = 1 (или ssthresh для Fast Recovery)
   - Возврат к Slow Start или Congestion Avoidance

## **TCP опции**

### **MSS (Maximum Segment Size)**

Максимальный размер сегмента данных.

**Формат:**
```
Kind: 2
Length: 4
MSS: 2 байта (значение)
```

**Типичные значения:**
- Ethernet: 1460 байт (1500 - 20 IP - 20 TCP)
- Jumbo frames: до 8960 байт

### **Window Scale**

Увеличение размера окна до 1 ГБ.

**Формат:**
```
Kind: 3
Length: 3
Shift count: 1 байт
```

**Расчет:**
```
Реальный размер окна = Window Size × 2^Shift
```

### **SACK (Selective Acknowledgment)**

Выборочное подтверждение получения.

**Формат:**
```
Kind: 5
Length: переменная
SACK blocks: пары (left edge, right edge)
```

**Преимущества:**
- Подтверждение получения отдельных блоков
- Не требует повторной передачи всех данных

### **Timestamp**

Измерение RTT и защита от старых сегментов.

**Формат:**
```
Kind: 8
Length: 10
Timestamp Value: 4 байта
Timestamp Echo Reply: 4 байта
```

## **Порты TCP**

### **Well-known порты (0-1023)**

| Порт | Протокол | Описание                                    |
| ---- | -------- | ------------------------------------------- |
| 20   | FTP      | FTP Data                                    |
| 21   | FTP      | FTP Control                                 |
| 22   | SSH      | Secure Shell                                |
| 23   | Telnet   | Telnet                                     |
| 25   | SMTP     | Simple Mail Transfer Protocol               |
| 53   | DNS      | Domain Name System (также UDP)              |
| 80   | HTTP     | HyperText Transfer Protocol                 |
| 110  | POP3     | Post Office Protocol v3                     |
| 143  | IMAP     | Internet Message Access Protocol            |
| 443  | HTTPS    | HTTP Secure                                 |
| 993  | IMAPS    | IMAP over SSL                               |
| 995  | POP3S    | POP3 over SSL                               |

### **Registered порты (1024-49151)**

Зарегистрированные порты для приложений.

### **Dynamic/Private порты (49152-65535)**

Эфемерные порты для клиентских соединений.

## **Состояния TCP соединения**

| Состояние      | Описание                                    |
| -------------- | ------------------------------------------- |
| **CLOSED**     | Соединение закрыто                          |
| **LISTEN**     | Сервер ожидает входящих соединений          |
| **SYN-SENT**   | Клиент отправил SYN, ждет ответа            |
| **SYN-RECEIVED** | Сервер получил SYN, отправил SYN-ACK      |
| **ESTABLISHED** | Соединение установлено, передача данных   |
| **FIN-WAIT-1** | Отправлен FIN, ждем ACK                     |
| **FIN-WAIT-2** | Получен ACK на FIN, ждем FIN от другой стороны |
| **CLOSE-WAIT** | Получен FIN, ждем закрытия приложением     |
| **CLOSING**    | Обе стороны отправили FIN, ждем ACK         |
| **LAST-ACK**  | Отправлен FIN, ждем финальный ACK           |
| **TIME-WAIT** | Ожидание перед полным закрытием (2×MSL)     |

**Диаграмма состояний:**
```
CLOSED → LISTEN (сервер)
CLOSED → SYN-SENT → ESTABLISHED (клиент)
ESTABLISHED → FIN-WAIT-1 → FIN-WAIT-2 → TIME-WAIT → CLOSED
ESTABLISHED → CLOSE-WAIT → LAST-ACK → CLOSED
```

## **Примеры использования**

### **Просмотр TCP соединений**

```bash
# Linux
netstat -tn
ss -tn

# Вывод:
# ESTAB      0      0 192.168.1.10:54321   192.168.1.100:80

# С детальной информацией
ss -tn state established

# Windows
netstat -an
```

### **Мониторинг TCP трафика**

```bash
# tcpdump
sudo tcpdump -i eth0 tcp

# Только SYN пакеты
sudo tcpdump -i eth0 'tcp[tcpflags] & tcp-syn != 0'

# Wireshark фильтры
tcp
tcp.port == 80
tcp.flags.syn == 1
tcp.analysis.retransmission
```

### **Настройка TCP параметров**

```bash
# Linux - просмотр параметров
sysctl net.ipv4.tcp_*

# Увеличение размера окна
sysctl -w net.core.rmem_max=16777216
sysctl -w net.core.wmem_max=16777216

# Включение SACK
sysctl -w net.ipv4.tcp_sack=1

# Включение Window Scaling
sysctl -w net.ipv4.tcp_window_scaling=1
```

## **Производительность TCP**

### **Оптимизация**

1. **Увеличение размеров буферов**
   ```bash
   sysctl -w net.core.rmem_max=16777216
   sysctl -w net.core.wmem_max=16777216
   ```

2. **Включение опций**
   - SACK для лучшей обработки потерь
   - Window Scaling для больших окон
   - Timestamp для точного RTT

3. **Настройка алгоритмов перегрузки**
   ```bash
   # Доступные алгоритмы
   cat /proc/sys/net/ipv4/tcp_available_congestion_control
   # cubic, reno, bbr, и т.д.

   # Установка алгоритма
   sysctl -w net.ipv4.tcp_congestion_control=bbr
   ```

### **Измерение производительности**

```bash
# iperf3 - тестирование пропускной способности
iperf3 -c server.example.com

# Измерение RTT
ping -c 10 server.example.com

# Анализ трафика
tcpdump -i eth0 -w capture.pcap
wireshark capture.pcap
```

## **Безопасность TCP**

### **Угрозы**

1. **SYN Flood** — перегрузка сервера SYN запросами
2. **TCP Hijacking** — перехват соединения
3. **TCP Reset Attack** — принудительное закрытие соединения

### **Защита**

1. **SYN Cookies** — защита от SYN Flood
   ```bash
   sysctl -w net.ipv4.tcp_syncookies=1
   ```

2. **Firewall** — фильтрация по портам и адресам

3. **Шифрование** — использование TLS/SSL поверх TCP

4. **Rate Limiting** — ограничение количества соединений

## **Применение TCP**

1. **Веб-браузинг**
   - HTTP/HTTPS используют TCP
   - Надежная доставка веб-страниц

2. **Электронная почта**
   - SMTP, POP3, IMAP используют TCP
   - Гарантированная доставка писем

3. **Удаленное управление**
   - SSH, Telnet, RDP используют TCP
   - Надежное соединение

4. **Файловый обмен**
   - FTP использует TCP
   - Гарантированная передача файлов

5. **Базы данных**
   - MySQL, PostgreSQL используют TCP
   - Надежная передача запросов и ответов

## **Ограничения TCP**

1. **Накладные расходы**
   - Заголовок 20+ байт
   - Установление соединения (3 пакета)
   - Подтверждения для каждого сегмента

2. **Задержка**
   - Ожидание подтверждений
   - Retransmission timeout
   - Не подходит для real-time приложений

3. **Head-of-line blocking**
   - Потеря одного пакета блокирует последующие
   - Решается в QUIC

4. **Не подходит для multicast**
   - TCP только point-to-point
   - Для multicast используется UDP

## **Сравнение с UDP**

| Характеристика | TCP | UDP |
| -------------- | --- | --- |
| **Соединение** | С установлением | Без установления |
| **Надежность** | Гарантирует доставку | Не гарантирует |
| **Порядок**    | Гарантирует | Не гарантирует |
| **Заголовок**  | 20+ байт | 8 байт |
| **Скорость**   | Медленнее | Быстрее |
| **Применение** | HTTP, FTP, SSH | DNS, VoIP, игры |
