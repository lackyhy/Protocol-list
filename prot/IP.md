**IP** (Internet Protocol) — основной протокол сетевого уровня стека TCP/IP, отвечающий за адресацию и маршрутизацию пакетов между сетями. IP обеспечивает доставку данных от источника к получателю через промежуточные сети, используя логическую адресацию.

## **Основные характеристики**

| Параметр                    | Описание                                                                 |
| --------------------------- | ------------------------------------------------------------------------ |
| **Уровень OSI**             | Сетевой (Network Layer)                                                   |
| **Тип протокола**           | Без установления соединения (connectionless)                             |
| **Надежность**              | Best-effort (не гарантирует доставку)                                    |
| **Версии**                  | IPv4 (32-битные адреса), IPv6 (128-битные адреса)                        |
| **Максимальный размер пакета** | 65,535 байт (IPv4), практически неограничен (IPv6)                    |
| **Фрагментация**            | Поддерживается в IPv4, не поддерживается в IPv6 (только на отправителе)  |

## **IPv4 (Internet Protocol version 4)**

### **Структура IPv4 заголовка**

| Поле                    | Размер (биты) | Описание                                    | Пример/Значение                    |
| ----------------------- | -------------- | ------------------------------------------- | ---------------------------------- |
| **Version**             | 4              | Версия IP (4 для IPv4)                      | `0100` (4)                         |
| **IHL**                 | 4              | Internet Header Length (длина заголовка в 32-битных словах) | `0101` (5 = 20 байт) |
| **Type of Service (TOS)** | 8            | Тип обслуживания (приоритет, задержка, пропускная способность) | `00000000` |
| **Total Length**         | 16             | Общая длина пакета (байты)                  | `0x005C` (92 байта)                |
| **Identification**       | 16             | Идентификатор пакета (для фрагментации)     | `0x1234`                           |
| **Flags**                | 3              | Флаги фрагментации                          | `010` (DF=0, MF=1)                 |
| **Fragment Offset**      | 13             | Смещение фрагмента (в 8-байтовых блоках)    | `0x0000`                           |
| **Time to Live (TTL)**   | 8              | Время жизни пакета (максимум прыжков)       | `0x40` (64)                        |
| **Protocol**             | 8              | Протокол верхнего уровня                    | `0x06` (TCP), `0x11` (UDP)         |
| **Header Checksum**      | 16             | Контрольная сумма заголовка                 | Рассчитывается на лету             |
| **Source Address**       | 32             | IP-адрес отправителя                        | `192.168.1.10`                     |
| **Destination Address**  | 32             | IP-адрес получателя                         | `192.168.1.100`                    |
| **Options**              | Переменная     | Опции (опционально, редко используется)      | Опционально                       |

**Минимальный размер заголовка:** 20 байт (без опций)
**Максимальный размер заголовка:** 60 байт (с опциями)

### **IPv4 адресация**

#### **Формат адреса**

32-битное число, представленное в виде четырех октетов:
```
192.168.1.10
```

**Диапазон:** `0.0.0.0` - `255.255.255.255`

#### **Классы адресов (устаревшая классификация)**

| Класс | Диапазон           | Маска по умолчанию | Назначение                    |
| ----- | ------------------ | ------------------ | ----------------------------- |
| **A** | 1.0.0.0 - 126.255.255.255 | /8 (255.0.0.0) | Большие сети                  |
| **B** | 128.0.0.0 - 191.255.255.255 | /16 (255.255.0.0) | Средние сети                  |
| **C** | 192.0.0.0 - 223.255.255.255 | /24 (255.255.255.0) | Малые сети                    |
| **D** | 224.0.0.0 - 239.255.255.255 | - | Multicast                      |
| **E** | 240.0.0.0 - 255.255.255.255 | - | Зарезервировано                |

#### **CIDR (Classless Inter-Domain Routing)**

Современный способ адресации без классов.

**Формат:** `IP-адрес/префикс`
```
192.168.1.0/24
```

**Примеры:**
- `/8` = 255.0.0.0 = 16,777,216 адресов
- `/16` = 255.255.0.0 = 65,536 адресов
- `/24` = 255.255.255.0 = 256 адресов
- `/32` = 255.255.255.255 = 1 адрес (host route)

#### **Специальные адреса**

| Адрес/Диапазон        | Назначение                                    |
| --------------------- | --------------------------------------------- |
| `0.0.0.0`             | Неопределенный адрес                          |
| `127.0.0.0/8`          | Loopback (localhost)                          |
| `169.254.0.0/16`      | Link-local (APIPA)                            |
| `10.0.0.0/8`          | Приватная сеть (RFC 1918)                     |
| `172.16.0.0/12`       | Приватная сеть (RFC 1918)                     |
| `192.168.0.0/16`      | Приватная сеть (RFC 1918)                     |
| `224.0.0.0/4`         | Multicast                                      |
| `240.0.0.0/4`         | Зарезервировано                                |
| `255.255.255.255`     | Broadcast                                      |

### **Фрагментация IPv4**

Когда пакет больше MTU (Maximum Transmission Unit) сети, он разбивается на фрагменты.

**Флаги фрагментации:**
- **Reserved**: Зарезервирован (всегда 0)
- **DF (Don't Fragment)**: Не фрагментировать
- **MF (More Fragments)**: Есть еще фрагменты

**Процесс:**
1. Пакет разбивается на части, каждая ≤ MTU
2. Каждый фрагмент имеет свой заголовок IP
3. Fragment Offset указывает позицию в исходном пакете
4. Получатель собирает фрагменты обратно

### **TTL (Time to Live)**

Счетчик прыжков, уменьшающийся на каждом маршрутизаторе.

**Назначение:**
- Предотвращение бесконечных циклов
- Ограничение времени жизни пакета

**Типичные значения:**
- Linux: 64
- Windows: 128
- Максимум: 255

## **IPv6 (Internet Protocol version 6)**

### **Основные отличия от IPv4**

| Характеристика | IPv4 | IPv6 |
| -------------- | ---- | ---- |
| **Размер адреса** | 32 бита (4 байта) | 128 бит (16 байт) |
| **Адресов**    | ~4.3 миллиарда | ~3.4×10³⁸ |
| **Заголовок**  | 20-60 байт | 40 байт (фиксированный) |
| **Фрагментация** | В маршрутизаторах | Только на отправителе |
| **NAT**        | Широко используется | Не требуется |
| **Безопасность** | Опциональна (IPsec) | Встроена (IPsec) |

### **Структура IPv6 заголовка**

| Поле                    | Размер (биты) | Описание                                    |
| ----------------------- | -------------- | ------------------------------------------- |
| **Version**             | 4              | Версия IP (6 для IPv6)                      |
| **Traffic Class**       | 8              | Класс трафика (аналог TOS)                  |
| **Flow Label**          | 20             | Метка потока                                |
| **Payload Length**      | 16             | Длина полезной нагрузки                     |
| **Next Header**         | 8              | Тип следующего заголовка                    |
| **Hop Limit**           | 8              | Аналог TTL                                  |
| **Source Address**      | 128            | IP-адрес отправителя                        |
| **Destination Address** | 128            | IP-адрес получателя                         |

**Размер заголовка:** 40 байт (фиксированный)

### **IPv6 адресация**

#### **Формат адреса**

128-битное число, представленное в виде восьми групп по 4 hex-цифры:
```
2001:0db8:85a3:0000:0000:8a2e:0370:7334
```

**Сокращенная запись:**
```
2001:db8:85a3::8a2e:370:7334
```

#### **Типы адресов IPv6**

| Тип           | Префикс | Описание                                    |
| ------------- | ------- | ------------------------------------------- |
| **Unicast**   | -       | Один получатель                              |
| **Multicast** | FF00::/8 | Множество получателей                        |
| **Anycast**   | -       | Ближайший из группы                         |

#### **Специальные адреса IPv6**

| Адрес                    | Назначение                                    |
| ------------------------ | --------------------------------------------- |
| `::`                     | Неопределенный адрес                          |
| `::1`                    | Loopback (localhost)                          |
| `FE80::/10`              | Link-local                                     |
| `FC00::/7`               | Уникальные локальные (ULA)                     |
| `2000::/3`               | Глобальные одноадресные                        |
| `FF00::/8`               | Multicast                                      |
| `FF02::1`                | All nodes (multicast)                          |
| `FF02::2`                | All routers (multicast)                        |

## **Протокольные поля (Protocol/Next Header)**

### **IPv4 Protocol поле**

| Значение (Hex) | Протокол | Описание                                    |
| -------------- | -------- | ------------------------------------------- |
| `0x01`         | ICMP     | Internet Control Message Protocol           |
| `0x06`         | TCP      | Transmission Control Protocol               |
| `0x11`         | UDP      | User Datagram Protocol                      |
| `0x32`         | SCTP     | Stream Control Transmission Protocol        |
| `0x33`         | FC       | Fibre Channel                               |
| `0x3A`         | ICMPv6   | Internet Control Message Protocol v6         |
| `0x47`         | GRE      | Generic Routing Encapsulation               |
| `0x50`         | ESP      | Encapsulating Security Payload              |
| `0x51`         | AH       | Authentication Header                       |

### **IPv6 Next Header поле**

Аналогичные значения, плюс расширенные заголовки:
- `0x00` - Hop-by-Hop Options
- `0x2C` - Fragment Header
- `0x3A` - ICMPv6
- `0x3B` - No Next Header
- `0x3C` - Destination Options

## **Маршрутизация**

### **Таблица маршрутизации**

Каждое устройство поддерживает таблицу маршрутов.

**Структура записи:**
- **Destination**: Сеть назначения
- **Gateway**: Шлюз для достижения сети
- **Interface**: Сетевой интерфейс
- **Metric**: Метрика (приоритет маршрута)

### **Типы маршрутов**

| Тип           | Описание                                    |
| ------------- | ------------------------------------------- |
| **Host Route** | Маршрут к конкретному хосту (/32)          |
| **Network Route** | Маршрут к сети                            |
| **Default Route** | Маршрут по умолчанию (0.0.0.0/0)          |

### **Примеры работы с маршрутизацией**

```bash
# Linux - просмотр таблицы маршрутизации
ip route show
# или
route -n

# Вывод:
# default via 192.168.1.1 dev eth0
# 192.168.1.0/24 dev eth0 proto kernel scope link src 192.168.1.10

# Добавление маршрута
sudo ip route add 10.0.0.0/8 via 192.168.1.1 dev eth0

# Удаление маршрута
sudo ip route del 10.0.0.0/8

# Добавление default gateway
sudo ip route add default via 192.168.1.1

# Windows
route print
route add 10.0.0.0 mask 255.0.0.0 192.168.1.1
```

## **NAT (Network Address Translation)**

Преобразование приватных IP-адресов в публичные.

### **Типы NAT**

| Тип           | Описание                                    |
| ------------- | ------------------------------------------- |
| **Static NAT** | Один-к-одному соответствие                  |
| **Dynamic NAT** | Пул публичных адресов                      |
| **PAT (NAT Overload)** | Множество приватных на один публичный (с портами) |

### **Процесс NAT**

```
Внутренняя сеть → NAT Router → Интернет
192.168.1.10:12345 → 203.0.113.1:54321 → 8.8.8.8:53
```

## **Примеры использования**

### **Настройка IP-адреса**

```bash
# Linux
sudo ip addr add 192.168.1.10/24 dev eth0
sudo ip link set eth0 up

# Или через ifconfig
sudo ifconfig eth0 192.168.1.10 netmask 255.255.255.0 up

# Windows
netsh interface ip set address "Ethernet" static 192.168.1.10 255.255.255.0 192.168.1.1
```

### **Проверка IP-адреса**

```bash
# Linux
ip addr show
ifconfig

# Windows
ipconfig
ipconfig /all
```

### **Мониторинг IP трафика**

```bash
# tcpdump
sudo tcpdump -i eth0 ip

# Только определенный протокол
sudo tcpdump -i eth0 ip proto 6  # TCP
sudo tcpdump -i eth0 ip proto 17 # UDP

# Wireshark фильтры
ip
ip.addr == 192.168.1.10
ip.src == 192.168.1.10
ip.dst == 192.168.1.100
```

## **Безопасность IP**

### **Угрозы**

1. **IP Spoofing** — подделка исходного IP-адреса
2. **IP Fragmentation Attacks** — атаки через фрагментацию
3. **Smurf Attack** — использование broadcast адресов

### **Защита**

1. **Ingress Filtering** — фильтрация входящих пакетов
2. **Egress Filtering** — фильтрация исходящих пакетов
3. **IPsec** — шифрование и аутентификация
4. **Firewall** — фильтрация по IP-адресам

## **Миграция с IPv4 на IPv6**

### **Механизмы перехода**

| Механизм      | Описание                                    |
| ------------- | ------------------------------------------- |
| **Dual Stack** | Поддержка обоих протоколов одновременно    |
| **Tunneling** | Инкапсуляция IPv6 в IPv4                    |
| **Translation** | Преобразование между IPv4 и IPv6          |

### **6to4 Tunneling**

Автоматическое создание туннелей IPv6 через IPv4.

### **Teredo**

Туннелирование IPv6 через NAT.

## **Применение IP**

1. **Интернет**
   - Основа глобальной сети
   - Маршрутизация между сетями

2. **Локальные сети**
   - Внутренняя маршрутизация
   - Подключение к интернету

3. **VPN**
   - Туннелирование через IP
   - Инкапсуляция других протоколов

4. **Мобильные сети**
   - IP в сотовых сетях
   - Мобильный IP

## **Ограничения и особенности**

1. **Не гарантирует доставку**
   - Пакеты могут быть потеряны
   - Нет подтверждений получения

2. **Не гарантирует порядок**
   - Пакеты могут прибыть в другом порядке
   - Реорганизация на верхних уровнях

3. **Не гарантирует целостность данных**
   - Контрольная сумма только заголовка
   - Проверка данных на верхних уровнях

4. **Ограниченный размер пакета**
   - Зависит от MTU сети
   - Требуется фрагментация

## **Сравнение IPv4 и IPv6**

| Характеристика | IPv4 | IPv6 |
| -------------- | ---- | ---- |
| **Адресация**  | 32 бита | 128 бит |
| **Заголовок**  | Переменный (20-60 байт) | Фиксированный (40 байт) |
| **Фрагментация** | В маршрутизаторах | Только на отправителе |
| **Безопасность** | Опциональна | Встроена |
| **Конфигурация** | Ручная или DHCP | Автоматическая (SLAAC) |
| **NAT**        | Широко используется | Не требуется |
| **Multicast**  | Опционально | Встроено |
| **Мобильность** | Ограничена | Встроена |
