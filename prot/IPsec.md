**IPsec** (Internet Protocol Security) — набор протоколов для защиты IP-пакетов на сетевом уровне. IPsec обеспечивает аутентификацию, целостность данных и конфиденциальность на уровне IP, используется для создания VPN, защищенных туннелей и безопасной связи между сетями.

## **Основные характеристики**

| Параметр                    | Описание                                                                 |
| --------------------------- | ------------------------------------------------------------------------ |
| **Уровень OSI**             | Сетевой (Network Layer)                                                   |
| **Транспорт**               | IP (протокол 50 - ESP, протокол 51 - AH)                                 |
| **Тип протокола**           | Туннелирование и транспортный режим                                      |
| **Шифрование**             | AES, 3DES, ChaCha20 и др.                                                |
| **Аутентификация**          | HMAC-SHA1, HMAC-SHA256 и др.                                             |
| **Режимы**                  | Transport Mode, Tunnel Mode                                              |

## **Компоненты IPsec**

### **1. AH (Authentication Header)**

Обеспечивает аутентификацию и целостность данных.

**Характеристики:**
- Протокол 51
- Не обеспечивает шифрование
- Защищает от подделки пакетов
- Редко используется (чаще ESP)

### **2. ESP (Encapsulating Security Payload)**

Обеспечивает шифрование, аутентификацию и целостность.

**Характеристики:**
- Протокол 50
- Шифрование данных
- Аутентификация и целостность
- Основной протокол IPsec

### **3. IKE (Internet Key Exchange)**

Протокол для обмена ключами и установления Security Associations.

**Версии:**
- **IKEv1** — устаревший
- **IKEv2** — современный (RFC 7296)

## **Режимы работы IPsec**

### **Transport Mode**

Защита только данных пакета, заголовок IP не изменяется.

```
[IP Header] [ESP Header] [TCP/UDP Header] [Data] [ESP Trailer] [Auth]
```

**Применение:**
- Host-to-Host связь
- Защита трафика между конечными точками
- Меньше накладных расходов

### **Tunnel Mode**

Инкапсуляция всего IP пакета в новый IP пакет.

```
[New IP Header] [ESP Header] [Original IP Header] [TCP/UDP] [Data] [ESP Trailer] [Auth]
```

**Применение:**
- Site-to-Site VPN
- Защита всего трафика
- Больше накладных расходов

## **Структура ESP пакета**

### **ESP Header**

| Поле                    | Размер (байты) | Описание                                    |
| ----------------------- | -------------- | ------------------------------------------- |
| **SPI**                 | 4              | Security Parameters Index                   |
| **Sequence Number**     | 4              | Номер последовательности                    |
| **Payload Data**        | Переменная     | Зашифрованные данные                        |
| **Padding**             | 0-255          | Заполнение (для выравнивания)               |
| **Pad Length**          | 1              | Длина заполнения                            |
| **Next Header**         | 1              | Тип следующего заголовка                    |
| **Authentication Data** | Переменная     | ICV (Integrity Check Value)                |

## **Security Association (SA)**

### **Концепция**

SA определяет параметры безопасности для связи:
- Алгоритмы шифрования
- Алгоритмы аутентификации
- Ключи
- SPI (Security Parameters Index)

### **Типы SA**

1. **Inbound SA** — для входящих пакетов
2. **Outbound SA** — для исходящих пакетов

### **SPD (Security Policy Database)**

База данных политик безопасности:
- Какие пакеты защищать
- Как защищать (AH/ESP, режим)
- Куда направлять

### **SAD (Security Association Database)**

База данных Security Associations:
- Параметры SA
- Ключи
- SPI

## **IKEv2 (Internet Key Exchange version 2)**

### **Процесс установления IKE SA**

```
Клиент                          Сервер
  |                               |
  |-------- IKE_SA_INIT ---------→|
  |         (DH, nonce)            |
  |                               |
  |<-- IKE_SA_INIT ----------------|
  |         (DH, nonce)            |
  |                               |
  |-------- IKE_AUTH -------------→|
  |         (ID, auth, cert)       |
  |                               |
  |<-- IKE_AUTH -------------------|
  |         (ID, auth, cert)       |
  |                               |
  |     IKE SA установлен         |
  |     (можно создавать Child SA) |
```

**Этапы:**
1. **IKE_SA_INIT** — обмен ключами (Diffie-Hellman)
2. **IKE_AUTH** — аутентификация и создание Child SA

### **Child SA**

После установления IKE SA создаются Child SA для защиты данных:
- ESP SA для шифрования трафика
- Может быть несколько Child SA

## **Алгоритмы шифрования**

### **Симметричное шифрование**

| Алгоритм      | Размер ключа | Безопасность | Скорость |
| ------------- | ------------ | ------------ | -------- |
| **AES-128**   | 128 бит       | Хорошая      | Быстрая  |
| **AES-256**   | 256 бит      | Отличная     | Средняя  |
| **3DES**      | 168 бит      | Устаревший   | Медленная |
| **ChaCha20**  | 256 бит      | Отличная     | Очень быстрая |

### **Аутентификация**

| Алгоритм          | Описание                                    |
| ----------------- | ------------------------------------------- |
| **HMAC-SHA1**     | SHA-1 с HMAC                                |
| **HMAC-SHA256**   | SHA-256 с HMAC                              |
| **HMAC-SHA512**   | SHA-512 с HMAC                              |
| **AES-GCM**       | AES в режиме GCM (шифрование + аутентификация) |

### **Обмен ключами**

| Алгоритм      | Описание                                    |
| ------------- | ------------------------------------------- |
| **DH Group 2** | 1024-битный DH                              |
| **DH Group 14** | 2048-битный DH (рекомендуется)             |
| **DH Group 15** | 3072-битный DH                              |
| **ECDH**      | Elliptic Curve Diffie-Hellman               |

## **Примеры использования**

### **Linux - strongSwan**

```bash
# Установка
sudo apt-get install strongswan strongswan-pki

# Генерация сертификатов
ipsec pki --gen --type rsa --size 4096 --outform pem > server-key.pem
ipsec pki --self --ca --lifetime 3652 --in server-key.pem \
  --dn "C=US, O=Example, CN=VPN CA" --outform pem > ca-cert.pem

# Конфигурация /etc/ipsec.conf
config setup
    charondebug="ike 2, knl 2, cfg 2"

conn %default
    ikelifetime=60m
    keylife=20m
    rekeymargin=3m
    keyingtries=1
    keyexchange=ikev2

conn vpn
    left=192.168.1.100
    leftcert=server-cert.pem
    leftsendcert=always
    leftsubnet=10.0.0.0/24
    right=%any
    rightauth=eap-mschapv2
    rightsourceip=10.0.1.0/24
    auto=add
```

### **Linux - Libreswan**

```bash
# Установка
sudo apt-get install libreswan

# Конфигурация /etc/ipsec.conf
version 2.0

config setup
    virtual_private=%v4:10.0.0.0/8,%v4:192.168.0.0/16

conn myvpn
    type=tunnel
    left=203.0.113.1
    leftsubnet=192.168.1.0/24
    right=203.0.113.2
    rightsubnet=192.168.2.0/24
    authby=secret
    ike=aes256-sha2;modp2048
    esp=aes256-sha2
    auto=start
```

### **Windows - встроенный IPsec**

```powershell
# Создание IPsec политики
New-NetIPsecRule -DisplayName "VPN Rule" `
  -RemoteAddress 203.0.113.0/24 `
  -Authentication Required `
  -Encryption Required
```

## **Безопасность IPsec**

### **Рекомендации**

1. **Использовать IKEv2** вместо IKEv1
2. **Сильные алгоритмы**
   - AES-256 для шифрования
   - SHA-256 для аутентификации
   - DH Group 14+ для обмена ключами

3. **Perfect Forward Secrecy**
   - Использовать Ephemeral DH
   - Регулярная смена ключей

4. **Ограничение доступа**
   - Firewall правила
   - Аутентификация

### **Угрозы**

1. **Man-in-the-Middle** — перехват трафика
2. **Replay Attacks** — повторная передача пакетов
3. **Key Compromise** — компрометация ключей

### **Защита**

1. **Аутентификация** — сертификаты, pre-shared keys
2. **Sequence Numbers** — защита от replay
3. **Регулярная смена ключей** — rekeying

## **Применение IPsec**

1. **Site-to-Site VPN** — соединение сетей
2. **Remote Access VPN** — удаленный доступ
3. **Host-to-Host** — защита связи между хостами
4. **Туннелирование** — защита трафика через публичные сети
5. **Защита трафика** — шифрование чувствительных данных

## **Ограничения IPsec**

1. **Сложность** — сложная настройка
2. **Производительность** — накладные расходы на шифрование
3. **NAT** — проблемы с NAT (требует NAT-T)
4. **Совместимость** — различия в реализациях

## **NAT Traversal (NAT-T)**

### **Проблема**

IPsec не работает через NAT, так как:
- Меняются IP-адреса
- Нарушается целостность пакетов

### **Решение**

NAT-T инкапсулирует IPsec в UDP (порт 4500):

```
[IP Header] [UDP Header] [ESP Header] [Data] [ESP Trailer] [Auth]
```

**Процесс:**
1. Обнаружение NAT (NAT-D payload)
2. Инкапсуляция в UDP
3. Использование порта 4500

## **Диагностика IPsec**

### **Проблемы и решения**

| Проблема                   | Причина                                  | Решение                                   |
| -------------------------- | ---------------------------------------- | ----------------------------------------- |
| **Не устанавливается SA**  | Firewall блокирует                       | Проверить firewall, открыть UDP 500, 4500 |
| **Ошибки аутентификации**  | Неверные ключи/сертификаты               | Проверить конфигурацию                    |
| **Трафик не проходит**     | Неверные политики                        | Проверить SPD, маршрутизацию              |

### **Отладка**

```bash
# strongSwan
sudo ipsec statusall
sudo ipsec stroke loglevel 4

# Libreswan
sudo ipsec auto --status
sudo ipsec whack --debug-all

# Мониторинг трафика
sudo tcpdump -i eth0 esp
sudo tcpdump -i eth0 udp port 500
sudo tcpdump -i eth0 udp port 4500
```

## **Сравнение с другими VPN**

| Характеристика | IPsec | OpenVPN | WireGuard |
| -------------- | ----- | ------- | --------- |
| **Производительность** | Хорошая | Средняя | Отличная |
| **Безопасность** | Отличная | Отличная | Отличная |
| **Сложность** | Высокая | Средняя | Низкая |
| **Стандартизация** | RFC | Проприетарный | RFC |
| **Поддержка** | Везде | Кроссплатформенный | Растущая |

## **Будущее IPsec**

- **Улучшенная производительность** — аппаратное ускорение
- **Упрощение настройки** — автоматическая конфигурация
- **Интеграция с облаками** — облачные VPN сервисы
- **Новые алгоритмы** — пост-квантовое шифрование
